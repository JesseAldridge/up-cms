<link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css@8.0.1/normalize.css">
<style>
  body {
    background: #272822;
    color: #55dbe7;
  }

  .main { padding-left: 30px; padding-bottom: 100px }

  h1 { margin-top: 20px; }

  .view-page { margin-top: 30px; }
  a { color: #ff618a; }

  #editor {
    width: 800px;
    height: 480px;
    margin-top: 30px;
    border: solid 1px white;
  }

  textarea { width: 600px; height: 400px; margin-top: 50px; }
  .valid-json { margin-top: 50px; }

  .buttons { margin-top: 20px; }
  input[type="submit"] {
    cursor: pointer;
    margin-right: 10px;
  }
</style>


<div class='main'>
  <h1>Admin Section</h1>

  <div class='view-page'><a href='/{{user_id}}'>View your page</a></div>

  <div id="editor">{{site_json}}</div>

  <div class='buttons'>
    <input type='submit' onclick="save()" value='Save'>
    <input type='submit' onclick="reset()" value='Reset'>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.2/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/monokai");
  editor.session.setMode("ace/mode/json");

  function save() {
    const content = editor.session.getValue()

    if(!check_valid_json(content)) {
      alert("Invalid JSON; not saved")
      return
    }

    fetch("/admin/{{user_id}}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: content
    }).then(function(response) {
      document.location.reload();
    });
  }

  function reset() {
    fetch("/reset/{{user_id}}", {method: 'POST'}).then(function(response) {
      document.location.reload();
    })
  }

  function check_valid_json(content) {
    try {
      JSON.parse(content);
    } catch(e) {
      return false
    }
    return true
  }
</script>
